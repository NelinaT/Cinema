<html>
    <head>
        {% load bootstrap5 %}
        {% bootstrap_css %}
        {% bootstrap_javascript %}
        <style>
            .container{
                position: absolute;
                /* right: 0px; */
                left: 1000px;
                top: 200px;
                width: 500px;
            }
        </style>
    </head>
    <body>
        
        <nav class="navbar navbar-expand-lg">
            <div class="container-fluid">
                <a class="navbar-brand" href="/">Cinema</a>
                <div class="collapse navbar-collapse">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link active" aria-current="page" href="/">Movies</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="agenda">Program</a>
                        </li>
                    </ul>
                </div>
            </div>
            {% if user.is_authenticated %}
                <a href="/logout" >Logout here</a>
            {% else %}
                <a href="/login" >Login here</a>
            {% endif %}
               
            </div>
        </nav>
        {% block content %}
        {% load static%}
        <figure>
            <img src="{% static hall_id %}"  alt="..." usemap="#image-map" id="image-map">
            <map name="image-map">
            {% load mathfilters %}
            {% for i in row_range %}
                {% for j in col_range %}
                    {% with  mlJ=j|mul:70 mlI=i|mul:70 %}
                    {% with x=starting_x|add:mlJ y=starting_y|add:mlI xx=starting_xx|add:mlJ yy=starting_yy|add:mlI %}
                    <area class="area" href="javascript:void(0);" coords="{{x}},{{y}},{{xx}},{{yy}}" shape="rect" data-row="{{row_count|sub:i}}" data-col="{{j|add:1}}">
                    {% endwith %}
                    {% endwith %}
                    
                {% endfor %}        
            {% endfor %}
        {% endblock %}
                </map>          
        </figure>
        <div class="container">

            <div>
                Currently you have chosen 
                <span id="ticketsNumber">0</span>
                seats!
            </div>
            <div>
                Current price:
                <span id="cost">0</span>
                lv.
            </div>
            <button type="button" class="btn btn-primary btn-lg">Continue</button>
        </div>

        <form action="/payment" style="display: none;" method="post">
            {% csrf_token %}
            <input id="seats"type="text" name="seats">
            <input id="projId"type="text" name="projId" value="{{projection.id}}">
        </form>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/maphilight/1.4.2/jquery.maphilight.min.js" integrity="sha512-1YiTT24MNHA6DRzyu+w9F5Egc8evYlyEnzSSTD4/M7q42xEb5fSpNgn0+1CPy3evubHs3xdlh8uXgae0DOhR7Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script>
        
            $("#image-map").maphilight({
                fill:true,
                fillOpacity: 0.4,
                fillColor: 'f7a201',
                stroke:true,
                // neverOn:true
                // strokeOpacity: 1,
                // fade:true,


            });
            $(".area").on("click",(e)=>{
                var $this =  $(e.currentTarget)
                var count = parseInt( $("#ticketsNumber").html())
                var data = $this.data('maphilight') || {};
                var cost = parseInt( $("#cost").html())

                $this.toggleClass("active")
                
                if (data.alwaysOn) {
                    data.alwaysOn = false;
                    count -=1
                }
                else {
                    data.alwaysOn=true;
                    count +=1
                }
                cost = count *  "{{price}}"
                $this.data('maphilight', data).trigger('alwaysOn.maphilight');

                $("#ticketsNumber").html(count)
                $("#cost").html(cost)
            });
            $(".btn").on("click",(e)=>{
                var seats = $('area.active');
                var data = [];
                var $formInput = $("form input#seats")

                for(var i=0; i< seats.length; i++){
                    data.push({
                        row: seats.eq(i).attr("data-row"),
                        col: seats.eq(i).attr("data-col")
                    });
                }
                $formInput.val(JSON.stringify(data)).parent().submit();
            });

           
            
        </script>
    </body>
</html>